#!/usr/bin/env node

var fs = require('fs');
var execSync = require('child_process').execSync;
var conventionalChangelog = require('conventional-changelog');
var tempfile = require('tempfile');
var addStream = require('add-stream');

var gemspec = JSON.parse(execSync('bundle exec exe/parse-gemspec-cli parse_gemspec-cli.gemspec'));

var options = { preset: 'angular' };
var templateContext = {
  version: gemspec.version,
  host: 'https://github.com',
  owner: 'packsaddle',
  repository: 'ruby-parse_gemspec-cli'
};
var infile = 'changelog.md';
var outfile = 'changelog.md';
var changelogStream = conventionalChangelog(options, templateContext)
  .on('error', function(err) {
    console.error(err.toString());
    process.exit(1);
  });

var tmp = tempfile();
var readStream = fs.createReadStream(infile);

changelogStream
  .pipe(addStream(readStream))
  .pipe(fs.createWriteStream(tmp))
  .on('finish', function() {
    fs.createReadStream(tmp)
      .pipe(fs.createWriteStream(outfile));
  });
